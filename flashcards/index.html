<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×•×œ×œ ×›×¨×˜×™×¡×™×•×ª ×–×™×›×¨×•×Ÿ ××•×¡×“×™</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f8f9fa; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; color: #333; }
        .box { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); max-width: 600px; width: 90%; position: relative; }
        
        /* ×œ×•×’×• ×‘××—×•×œ×œ */
        #generatorLogo { max-height: 80px; margin-bottom: 20px; display: none; }
        
        h1 { color: #2c3e50; margin-bottom: 5px; font-size: 1.8rem; }
        p { color: #7f8c8d; margin-bottom: 30px; font-size: 0.95rem; }
        
        .step { margin-bottom: 20px; padding: 20px; border-radius: 12px; background-color: #fff; border: 1px solid #e1e4e8; transition: 0.3s; text-align: right; }
        .step:hover { border-color: #3498db; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .step-title { font-weight: 800; margin-bottom: 12px; display: block; color: #34495e; font-size: 1.1rem; }
        
        /* ×›×¤×ª×•×¨×™× */
        .custom-file-upload {
            display: inline-block; padding: 10px 20px; cursor: pointer;
            background-color: #eef2f7; color: #2c3e50; border: 1px solid #ced4da;
            border-radius: 6px; font-weight: 600; transition: 0.2s; font-size: 0.9rem;
        }
        .custom-file-upload:hover { background-color: #dfe6ed; }
        input[type="file"] { display: none; }

        #downloadBtn {
            display: none; width: 100%; padding: 14px; font-size: 1.1rem;
            background-color: #27ae60; color: white; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
            transition: 0.2s; margin-top: 10px;
        }
        #downloadBtn:hover { background-color: #219150; transform: translateY(-2px); }

        #status { margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        .success { color: #27ae60; }
        .error { color: #c0392b; }
        
        .preview-img { max-height: 50px; vertical-align: middle; margin-right: 10px; border-radius: 4px; display: none;}
    </style>
</head>
<body>

<div class="box">
    <img id="generatorLogo" src="" alt="Logo">
    <h1>××—×•×œ×œ ×›×¨×˜×™×¡×™×•×ª</h1>
    <p>×™×¦×™×¨×ª ××©×—×§ ×–×™×›×¨×•×Ÿ ××™× ×˜×¨××§×˜×™×‘×™ ××§×‘×¦×™ Excel/CSV</p>
    
    <div class="step">
        <span class="step-title">1. ×”×¢×œ××ª ×œ×•×’×• ××•×¡×“ (××•×¤×¦×™×•× ×œ×™)</span>
        <label for="logoInput" class="custom-file-upload">
            ğŸ–¼ï¸ ×‘×—×¨×™ ×§×•×‘×¥ ×ª××•× ×”
        </label>
        <input type="file" id="logoInput" accept="image/*" />
        <img id="logoPreview" class="preview-img" />
        <span id="logoStatus" style="font-size: 0.8rem; color: gray;"></span>
    </div>

    <div class="step">
        <span class="step-title">2. ×˜×¢×™× ×ª ×©××œ×•×ª ×•×ª×©×•×‘×•×ª</span>
        <label for="fileInput" class="custom-file-upload">
            ğŸ“‚ ×‘×—×¨×™ ×§×•×‘×¥ Excel ××• CSV
        </label>
        <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
        <div id="status">×××ª×™×Ÿ ×œ×§×•×‘×¥...</div>
    </div>

    <button id="downloadBtn" onclick="downloadGame()">â¬‡ï¸ ×”×•×¨×™×“×™ ××ª ×”××©×—×§ ×”××•×›×Ÿ</button>
</div>

<script>
    let processedCards = null;
    let logoBase64 = null; // ××©×ª× ×” ×œ×©××™×¨×ª ×”×œ×•×’×•

    // --- ×˜×™×¤×•×œ ×‘×œ×•×’×• ---
    document.getElementById('logoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            logoBase64 = e.target.result; // ×©××™×¨×ª ×”×ª××•× ×” ×›×§×•×“ Base64
            
            // ×”×¦×’×” ×‘××—×•×œ×œ ×¢×¦××•
            const genLogo = document.getElementById('generatorLogo');
            genLogo.src = logoBase64;
            genLogo.style.display = 'block';
            
            // ×”×¦×’×” ××§×“×™××” ×§×˜× ×” ×œ×™×“ ×”×›×¤×ª×•×¨
            const preview = document.getElementById('logoPreview');
            preview.src = logoBase64;
            preview.style.display = 'inline-block';
            
            document.getElementById('logoStatus').innerText = "×”×œ×•×’×• × ×˜×¢×Ÿ ×‘×”×¦×œ×—×” ×•×™×¦×•×¨×£ ×œ××©×—×§.";
        };
        reader.readAsDataURL(file);
    });

    // --- ×˜×™×¤×•×œ ×‘×§×•×‘×¥ × ×ª×•× ×™× ---
    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        const statusDiv = document.getElementById('status');
        const downloadBtn = document.getElementById('downloadBtn');
        
        downloadBtn.style.display = "none";
        statusDiv.className = "";
        processedCards = null;

        if (!file) return;

        statusDiv.innerText = "×§×•×¨× ×§×•×‘×¥...";
        
        const reader = new FileReader();
        const isCSV = file.name.toLowerCase().endsWith('.csv');

        // ×¤×•× ×§×¦×™×” ×œ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ××—×¨×™ ×©×”× × ×§×¨××•
        const processWorkbook = (workbook) => {
            try {
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                const validData = [];
                for(let i=0; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    if(row.length >= 2 && row[0] != null && row[1] != null) {
                        let q = row[0].toString().trim();
                        let a = row[1].toString().trim();
                        if (i === 0 && (q.includes("×©××œ×”") || q.toLowerCase().includes("question"))) continue;
                        if (q === "" || a === "") continue;
                        validData.push({ question: q, answer: a });
                    }
                }

                if (validData.length === 0) throw new Error("×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™×.");

                processedCards = validData;
                statusDiv.innerText = `âœ… × ×˜×¢× ×• ${validData.length} ×©××œ×•×ª!`;
                statusDiv.className = "success";
                downloadBtn.style.display = "block";
            } catch (err) {
                statusDiv.innerText = "âŒ ×©×’×™××”: " + err.message;
                statusDiv.className = "error";
            }
        };

        // ×œ×•×’×™×§×” ××¤×•×¦×œ×ª: CSV ×§×•×¨××™× ×›×˜×§×¡×˜ (UTF-8), ××§×¡×œ ×›×‘×™× ××¨×™
        if (isCSV) {
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    // ×”××¨×” ×™×“× ×™×ª ×‘×××¦×¢×•×ª SheetJS, ××›×¨×™×—×™× ×œ×§×¨×•× ×›×˜×§×¡×˜
                    const workbook = XLSX.read(text, {type: 'string'});
                    processWorkbook(workbook);
                } catch(err) {
                    statusDiv.innerText = "×©×’×™××” ×‘×§×¨×™××ª CSV.";
                }
            };
            reader.readAsText(file, "UTF-8"); // ×›××Ÿ ×”×§×¡× ×©×¤×•×ª×¨ ××ª ×”×’'×™×‘×¨×™×©
        } else {
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    processWorkbook(workbook);
                } catch(err) {
                    statusDiv.innerText = "×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ Excel.";
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }

    // --- ×™×¦×™×¨×ª ×•×”×•×¨×“×ª ×”××©×—×§ ---
    function downloadGame() {
        if (!processedCards) return;

        // ×”×›× ×ª ×ª×’×™×ª ×”×œ×•×’×• ×œ××©×—×§ (×× ×”×•×¢×œ×” ×œ×•×’×•)
        const logoHTML = logoBase64 ? `<img src="${logoBase64}" class="game-logo" alt="Logo">` : '';

        const htmlContent = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×¨×˜×™×¡×™×•×ª ×ª×¨×’×•×œ</title>
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\\\(', '\\\\)']], displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']] }
    };
    <\/script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; position: relative; }
        
        /* ×œ×•×’×• ×‘×ª×•×š ×”××©×—×§ */
        .game-logo { position: absolute; top: 20px; right: 20px; max-height: 60px; z-index: 10; opacity: 0.9; }
        
        .container { perspective: 1000px; width: 80%; max-width: 600px; height: 400px; position: relative; margin-top: 20px; }
        .card { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); cursor: pointer; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .card.flipped { transform: rotateX(180deg); }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; box-sizing: border-box; text-align: center; border-radius: 20px; font-size: 1.6rem; color: #333; overflow-y: auto; background-color: white; line-height: 1.4; }
        .front { background: linear-gradient(135deg, #ffffff 0%, #e6f7ff 100%); border: 2px solid #b3e0ff; }
        .back { background: linear-gradient(135deg, #ffffff 0%, #fff0f0 100%); border: 2px solid #ffcccc; transform: rotateX(180deg); }
        
        .controls { margin-top: 30px; display: flex; gap: 20px; }
        button { padding: 12px 24px; font-size: 1rem; border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-family: inherit; font-weight: 600; }
        #nextBtn { background-color: #4CAF50; color: white; }
        #nextBtn:hover { background-color: #45a049; transform: translateY(-2px); }
        #resetBtn { background-color: #FF9800; color: white; }
        #resetBtn:hover { background-color: #e68a00; transform: translateY(-2px); }
        .progress { margin-top: 15px; color: #666; font-size: 0.9rem; }
        .hint { margin-top: 10px; font-size: 0.8rem; color: #888; }
        mjx-container { font-size: 110% !important; }
        
        /* ×”×ª×××” ×œ× ×™×™×“ */
        @media (max-width: 600px) {
            .container { height: 60vh; width: 90%; }
            .face { font-size: 1.2rem; padding: 15px; }
            .game-logo { max-height: 40px; top: 10px; right: 10px; }
        }
    </style>
</head>
<body>
    ${logoHTML}
    <div class="container" onclick="flipCard()">
        <div class="card" id="card">
            <div class="face front"><div id="questionText">×˜×•×¢×Ÿ...</div></div>
            <div class="face back"><div id="answerText">×˜×•×¢×Ÿ...</div></div>
        </div>
    </div>
    <div class="progress" id="progressText"></div>
    <div class="controls">
        <button id="resetBtn" onclick="resetGame(event)">××™×¤×•×¡</button>
        <button id="nextBtn" onclick="nextCard(event)">×”×‘× (Enter)</button>
    </div>
    <div class="hint">×¨×•×•×— ×œ×”×¤×•×š, Enter ×œ××¢×‘×¨</div>
    <script>
        const cardsData = ${JSON.stringify(processedCards)};
        let deck = [];
        let currentCardIndex = -1;
        
        function initGame() { 
            deck = Array.from(Array(cardsData.length).keys()); 
            shuffleDeck(); 
            nextCard(); 
        }
        
        function shuffleDeck() { 
            for (let i = deck.length - 1; i > 0; i--) { 
                const j = Math.floor(Math.random() * (i + 1)); 
                [deck[i], deck[j]] = [deck[j], deck[i]]; 
            } 
        }
        
        function updateProgress() { 
            const remaining = deck.length; 
            const total = cardsData.length; 
            document.getElementById('progressText').innerText = \`×›×¨×˜×™×¡×™×™×” \${total - remaining} ××ª×•×š \${total}\`; 
        }
        
        function nextCard(event) { 
            if (event) event.stopPropagation(); 
            if (deck.length === 0) { 
                alert("×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”×›×¨×˜×™×¡×™×•×ª."); 
                initGame(); 
                return; 
            } 
            const cardElement = document.getElementById('card'); 
            cardElement.classList.remove('flipped'); 
            
            currentCardIndex = deck.pop(); 
            
            setTimeout(() => { 
                document.getElementById('questionText').innerHTML = cardsData[currentCardIndex].question; 
                document.getElementById('answerText').innerHTML = cardsData[currentCardIndex].answer; 
                if (window.MathJax) { 
                    MathJax.typesetPromise([document.getElementById('card')]).catch((err) => console.log(err)); 
                } 
                updateProgress(); 
            }, 200); 
        }
        
        function flipCard() { 
            document.getElementById('card').classList.toggle('flipped'); 
        }
        
        function resetGame(event) { 
            if (event) event.stopPropagation(); 
            if (confirm("×œ×”×ª×—×™×œ ××—×“×©?")) initGame(); 
        }
        
        document.addEventListener('keydown', function(event) { 
            if (event.code === 'Space') { event.preventDefault(); flipCard(); } 
            else if (event.code === 'Enter') { event.preventDefault(); nextCard(); } 
        });
        
        window.onload = initGame;
    <\/script>
</body>
</html>`;

        const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "flashcards_game.html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
