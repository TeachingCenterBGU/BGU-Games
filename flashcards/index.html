<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×•×œ×œ ×›×¨×˜×™×¡×™×•×ª - ×”×™×—×™×“×” ×œ×—×“×©× ×•×ª ×‘×”×•×¨××”</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #0056b3; /* ×¦×‘×¢ ×›×—×•×œ ××•×¡×“×™ - × ×™×ª×Ÿ ×œ×©×™× ×•×™ */
            --bg-color: #f4f7f6;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg-color); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            color: #333; 
        }

        /* ×¢×™×¦×•×‘ ×”×œ×•×’×• ×‘××—×•×œ×œ */
        header {
            width: 100%;
            background: white;
            padding: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
            margin-bottom: 30px;
        }

        #headerLogoImg {
            max-height: 80px;
            display: none; /* ××•×¡×ª×¨ ×¢×“ ×©××¢×œ×™× ×ª××•× ×” */
            margin: 0 auto;
        }

        #defaultHeaderTitle {
            margin: 0;
            color: var(--primary-color);
        }

        .box { 
            background: white; 
            padding: 40px; 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.08); 
            max-width: 600px; 
            width: 90%; 
            text-align: center;
        }
        
        h2 { margin-top: 0; color: #444; }
        p { color: #666; font-size: 0.95rem; margin-bottom: 25px; line-height: 1.5; }
        
        /* ××–×•×¨×™ ×”×¢×œ××” */
        .upload-section {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: 0.3s;
            background: #fafafa;
            position: relative;
        }
        
        .upload-section:hover {
            border-color: var(--primary-color);
            background: #f0f7ff;
        }

        .upload-label {
            display: block;
            cursor: pointer;
            font-weight: 600;
            color: #555;
        }

        .upload-icon { font-size: 2rem; display: block; margin-bottom: 10px; }
        
        input[type="file"] { display: none; }

        /* ×›×¤×ª×•×¨ ×”×•×¨×“×” */
        #downloadBtn {
            display: none; 
            width: 100%; 
            padding: 16px; 
            font-size: 1.2rem;
            background-color: #27ae60; 
            color: white; 
            border: none; 
            border-radius: 8px;
            cursor: pointer; 
            font-weight: 700; 
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
            transition: 0.2s; 
            margin-top: 10px;
        }
        #downloadBtn:hover { background-color: #219150; transform: translateY(-2px); }

        #status { margin-top: 15px; font-weight: bold; font-size: 0.9rem; min-height: 20px;}
        .success { color: #27ae60; }
        .error { color: #c0392b; }

    </style>
</head>
<body>

    <header id="mainHeader">
        <h1 id="defaultHeaderTitle">××—×•×œ×œ ×›×¨×˜×™×¡×™×•×ª ×–×™×›×¨×•×Ÿ</h1>
        <img id="headerLogoImg" src="" alt="×œ×•×’×• ××•×¡×“">
    </header>

    <div class="box">
        <h2>×™×¦×™×¨×ª ××©×—×§ ×—×“×©</h2>
        <p>×›××Ÿ ×ª×•×›×œ×• ×œ×”×¤×•×š ×§×‘×¦×™ Excel ××• CSV ×××©×§ NotebookLM ×œ××©×—×§ ×›×¨×˜×™×¡×™×•×ª ××™× ×˜×¨××§×˜×™×‘×™ ×•×××•×ª×’.</p>
        
        <div class="upload-section">
            <label for="logoInput" class="upload-label">
                <span class="upload-icon">ğŸ–¼ï¸</span>
                <span>×œ×—×¦×™ ×›××Ÿ ×œ×”×•×¡×¤×ª ×œ×•×’×• ×”××•×¡×“</span>
                <div style="font-size: 0.8rem; font-weight: normal; color: #888; margin-top: 5px;">(×”×œ×•×’×• ×™×•×¤×™×¢ ×›××Ÿ ×œ××¢×œ×” ×•×’× ×‘××©×—×§ ×”×¡×•×¤×™)</div>
            </label>
            <input type="file" id="logoInput" accept="image/*" />
        </div>

        <div class="upload-section">
            <label for="fileInput" class="upload-label">
                <span class="upload-icon">ğŸ“‚</span>
                <span>×œ×—×¦×™ ×›××Ÿ ×œ×”×¢×œ××ª ×§×•×‘×¥ ×”×©××œ×•×ª</span>
                <div style="font-size: 0.8rem; font-weight: normal; color: #888; margin-top: 5px;">(Excel ××• CSV)</div>
            </label>
            <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
        </div>

        <div id="status"></div>
        <button id="downloadBtn" onclick="downloadGame()">â¬‡ï¸ ×”×•×¨×™×“×™ ××ª ×”××©×—×§ ×”××•×›×Ÿ</button>
    </div>

<script>
    let processedCards = null;
    let logoBase64 = null; 

    // --- ×˜×™×¤×•×œ ×‘×œ×•×’×• ---
    document.getElementById('logoInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            logoBase64 = e.target.result; 
            
            // ×¢×“×›×•×Ÿ ×”×××©×§ ×”× ×•×›×—×™ - ×”×—×œ×¤×ª ×”×›×•×ª×¨×ª ×‘×œ×•×’×•
            const img = document.getElementById('headerLogoImg');
            const title = document.getElementById('defaultHeaderTitle');
            
            img.src = logoBase64;
            img.style.display = 'block';
            title.style.display = 'none'; // ×”×¡×ª×¨×ª ×”×˜×§×¡×˜ ×œ×˜×•×‘×ª ×”×œ×•×’×•
            
            // ×©×™× ×•×™ ×§×˜×Ÿ ×œ×¢×™×¦×•×‘ ×”×ª×™×‘×” ×›×“×™ ×œ×¡××Ÿ ×”×¦×œ×—×”
            e.target.parentElement.style.borderColor = '#27ae60';
            e.target.parentElement.querySelector('span:nth-child(2)').innerText = "×”×œ×•×’×• × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!";
        };
        reader.readAsDataURL(file);
    });

    // --- ×˜×™×¤×•×œ ×‘×§×•×‘×¥ × ×ª×•× ×™× (×›×•×œ×œ ×ª×™×§×•×Ÿ UTF-8) ---
    document.getElementById('fileInput').addEventListener('change', handleFile, false);

    function handleFile(e) {
        const file = e.target.files[0];
        const statusDiv = document.getElementById('status');
        const downloadBtn = document.getElementById('downloadBtn');
        
        downloadBtn.style.display = "none";
        statusDiv.className = "";
        processedCards = null;

        if (!file) return;

        statusDiv.innerText = "××¢×‘×“ ×§×•×‘×¥...";
        
        const reader = new FileReader();
        const fileName = file.name.toLowerCase();
        const isCSV = fileName.endsWith('.csv');

        // ×¤×•× ×§×¦×™×” ×œ×¢×™×‘×•×“ ×”× ×ª×•× ×™× ××—×¨×™ ×©×”× × ×§×¨××•
        const processWorkbook = (workbook) => {
            try {
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                
                const validData = [];
                for(let i=0; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    // ×‘×“×™×§×” ××ª×™×¨× ×™×ª ×™×•×ª×¨ - ××¡×¤×™×§ ×©×™×© ×ª× ××—×“ ××œ× ×›×“×™ ×œ× ×¡×•×ª ×œ×§×¨×•×
                    if(row.length >= 2 && row[0] != null && row[1] != null) {
                        let q = row[0].toString().trim();
                        let a = row[1].toString().trim();
                        
                        // × ×™×§×•×™ ××¨×›××•×ª ×›×¤×•×œ×•×ª ×©×¢×©×•×™×•×ª ×œ×”×’×™×¢ ×-CSV
                        if (q.startsWith('"') && q.endsWith('"')) q = q.slice(1, -1).replace(/""/g, '"');
                        if (a.startsWith('"') && a.endsWith('"')) a = a.slice(1, -1).replace(/""/g, '"');

                        // ×¡×™× ×•×Ÿ ×›×•×ª×¨×•×ª
                        if (i === 0 && (q.includes("×©××œ×”") || q.toLowerCase().includes("question"))) continue;
                        if (q === "" || a === "") continue;
                        
                        validData.push({ question: q, answer: a });
                    }
                }

                if (validData.length === 0) throw new Error("×œ× × ××¦××• × ×ª×•× ×™× ×ª×§×™× ×™×. ×•×•×“××™ ×©×¢××•×“×” A ×”×™× ×©××œ×” ×•×¢××•×“×” B ×”×™× ×ª×©×•×‘×”.");

                processedCards = validData;
                statusDiv.innerText = `âœ… × ×˜×¢× ×• ${validData.length} ×›×¨×˜×™×¡×™×•×ª!`;
                statusDiv.className = "success";
                downloadBtn.style.display = "block";
                
                // ×¡×™××•×Ÿ ×•×™×–×•××œ×™ ×‘×ª×™×‘×ª ×”×”×¢×œ××”
                document.getElementById('fileInput').parentElement.style.borderColor = '#27ae60';
                
            } catch (err) {
                console.error(err);
                statusDiv.innerText = "âŒ ×©×’×™××”: " + err.message;
                statusDiv.className = "error";
            }
        };

        // ×œ×•×’×™×§×” ×œ×˜×™×¤×•×œ ×‘×§×™×“×•×“
        if (isCSV) {
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    // ×§×¨×™××ª ×”-CSV ×›×˜×§×¡×˜ ×¢× ×§×™×“×•×“ UTF-8 ××¤×•×¨×©
                    const workbook = XLSX.read(text, {type: 'string'});
                    processWorkbook(workbook);
                } catch(err) {
                    statusDiv.innerText = "×©×’×™××” ×‘×§×¨×™××ª ×”-CSV.";
                }
            };
            // ×”×¤×§×•×“×” ×”×–×• ×§×¨×™×˜×™×ª ×œ×ª×™×§×•×Ÿ ×”×’'×™×‘×¨×™×© ×-NotebookLM
            reader.readAsText(file, "UTF-8"); 
        } else {
            // ×¢×‘×•×¨ ××§×¡×œ ×¨×’×™×œ
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    processWorkbook(workbook);
                } catch(err) {
                    statusDiv.innerText = "×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ Excel.";
                }
            };
            reader.readAsArrayBuffer(file);
        }
    }

    // --- ×™×¦×™×¨×ª ×§×•×‘×¥ ×”-HTML ×”×¡×•×¤×™ ---
    function downloadGame() {
        if (!processedCards) return;

        // ×‘× ×™×™×ª ×”-HTML ×©×œ ×”×œ×•×’×• ×œ××©×—×§
        const logoHTML = logoBase64 
            ? `<div class="logo-container"><img src="${logoBase64}" alt="Logo"></div>` 
            : '';

        const htmlContent = `<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×¨×˜×™×¡×™×•×ª ×ª×¨×’×•×œ</title>
    <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\\\(', '\\\\)']], displayMath: [['$$', '$$'], ['\\\\[', '\\\\]']] }
    };
    <\/script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
        }
        
        /* ×¢×™×¦×•×‘ ×”×œ×•×’×• ×‘××©×—×§ */
        .logo-container {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 10;
        }
        .logo-container img {
            max-height: 70px;
            max-width: 200px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container { 
            perspective: 1000px; 
            width: 90%; 
            max-width: 600px; 
            height: 400px; 
            position: relative; 
            margin-top: 60px; /* ××§×•× ×œ×œ×•×’×• */
        }
        
        .card { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            transform-style: preserve-3d; 
            transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1); 
            cursor: pointer; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }
        
        .card.flipped { transform: rotateX(180deg); }
        
        .face { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 25px; 
            box-sizing: border-box; 
            text-align: center; 
            border-radius: 20px; 
            font-size: 1.5rem; 
            color: #333; 
            overflow-y: auto; 
            background-color: white; 
        }
        
        .front { 
            background: linear-gradient(135deg, #ffffff 0%, #f0f7ff 100%); 
            border: 2px solid #cce4ff; 
        }
        
        .back { 
            background: linear-gradient(135deg, #ffffff 0%, #fff5f5 100%); 
            border: 2px solid #ffdbdb; 
            transform: rotateX(180deg); 
        }
        
        .controls { margin-top: 30px; display: flex; gap: 20px; z-index: 20; }
        
        button { 
            padding: 12px 24px; 
            font-size: 1rem; 
            border: none; 
            border-radius: 50px; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            font-family: inherit; 
            font-weight: 600; 
        }
        
        #nextBtn { background-color: #4CAF50; color: white; }
        #nextBtn:hover { background-color: #45a049; transform: translateY(-2px); }
        #resetBtn { background-color: #FF9800; color: white; }
        #resetBtn:hover { background-color: #e68a00; transform: translateY(-2px); }
        
        .progress { margin-top: 15px; color: #666; font-size: 0.9rem; }
        .hint { margin-top: 10px; font-size: 0.8rem; color: #888; margin-bottom: 20px; }
        
        mjx-container { font-size: 110% !important; }

        @media (max-height: 600px) {
            .container { height: 300px; margin-top: 50px; }
            .face { font-size: 1.2rem; }
            .logo-container img { max-height: 50px; }
        }
    </style>
</head>
<body>
    ${logoHTML}
    
    <div class="container" onclick="flipCard()">
        <div class="card" id="card">
            <div class="face front"><div id="questionText">×˜×•×¢×Ÿ...</div></div>
            <div class="face back"><div id="answerText">×˜×•×¢×Ÿ...</div></div>
        </div>
    </div>
    
    <div class="progress" id="progressText"></div>
    
    <div class="controls">
        <button id="resetBtn" onclick="resetGame(event)">××™×¤×•×¡</button>
        <button id="nextBtn" onclick="nextCard(event)">×”×‘× (Enter)</button>
    </div>
    <div class="hint">×¨×•×•×— ×œ×”×¤×•×š, Enter ×œ××¢×‘×¨</div>

    <script>
        const cardsData = ${JSON.stringify(processedCards)};
        let deck = [];
        let currentCardIndex = -1;
        
        function initGame() { 
            deck = Array.from(Array(cardsData.length).keys()); 
            shuffleDeck(); 
            nextCard(); 
        }
        
        function shuffleDeck() { 
            for (let i = deck.length - 1; i > 0; i--) { 
                const j = Math.floor(Math.random() * (i + 1)); 
                [deck[i], deck[j]] = [deck[j], deck[i]]; 
            } 
        }
        
        function updateProgress() { 
            const remaining = deck.length; 
            const total = cardsData.length; 
            document.getElementById('progressText').innerText = \`×›×¨×˜×™×¡×™×™×” \${total - remaining} ××ª×•×š \${total}\`; 
        }
        
        function nextCard(event) { 
            if (event) event.stopPropagation(); 
            if (deck.length === 0) { 
                alert("×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×›×œ ×”×›×¨×˜×™×¡×™×•×ª."); 
                initGame(); 
                return; 
            } 
            const cardElement = document.getElementById('card'); 
            cardElement.classList.remove('flipped'); 
            
            currentCardIndex = deck.pop(); 
            
            setTimeout(() => { 
                document.getElementById('questionText').innerHTML = cardsData[currentCardIndex].question; 
                document.getElementById('answerText').innerHTML = cardsData[currentCardIndex].answer; 
                if (window.MathJax) { 
                    MathJax.typesetPromise([document.getElementById('card')]).catch((err) => console.log(err)); 
                } 
                updateProgress(); 
            }, 200); 
        }
        
        function flipCard() { 
            document.getElementById('card').classList.toggle('flipped'); 
        }
        
        function resetGame(event) { 
            if (event) event.stopPropagation(); 
            if (confirm("×œ×”×ª×—×™×œ ××—×“×©?")) initGame(); 
        }
        
        document.addEventListener('keydown', function(event) { 
            if (event.code === 'Space') { event.preventDefault(); flipCard(); } 
            else if (event.code === 'Enter') { event.preventDefault(); nextCard(); } 
        });
        
        window.onload = initGame;
    <\/script>
</body>
</html>`;

        const blob = new Blob([htmlContent], {type: "text/html;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "flashcards_game.html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
</script>

</body>
</html>
